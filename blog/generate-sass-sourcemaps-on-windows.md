Title:   Generate SASS sourcemaps on Windows
Author:  Mihai Rotaru
Date:    February 4, 2014
Updated: February 5, 2014
Tags:    CSS,SASS,SCSS,sourcemaps,DevTools,Vim

# Generate SASS sourcemaps on Windows

You might be aware of the awesomeness that is possible with upcoming Sass 3.3
and Chrome DevTools. It allows you to treat SCSS as CSS - with inline editing,
and all that. Check [this](https://www.youtube.com/watch?v=x6qe_kVaBpg) out, if
you're not. It's a video from the 2013 Google IO conference, with Paul Irish
showing you what can be achieved.

#### Why would I need sourcemaps ?

The biggest problem with SCSS and other pre-processors is that you write in one
language (SCSS), but in you DevTools/Firebug, you get CSS. This indirection can
make it difficult to "map" the generated CSS to the SCSS you've written.

For example, you can see that a button is red. You fire up DevTools to see
where that color is set. You quickly spot the CSS rule, but then you realize
that the CSS you're looking at was actually generated by `sass` from your SCSS
file! And you have to manually look through the SCSS code, trying to find which
SCSS rule generated the CSS rule.

In simple cases, this "mapping" might not be an issue. However, in projects of
any significance, this can be frustrating.

This is the problem sourcemaps are meant to solve. Basically, you tell `sass`
that when it generates CSS files from your SCSS code, it should also create a
file that explicitly states which SCSS code generated each CSS statement.

So, if you have style.scss, after running `sass` you get the usual style.css, and
style.map. This .map file is not meant for human consumption, but Chrome
DevTools knows how to read it, and enables it to tell exactly where each CSS
statement comes from. Effectively, it maps the contents of the generated CSS
file back to the "source" SCSS code. Hence, sourcemap!

#### Getting `sass` to work on Windows

Setup for unixy platforms is easy, described
[here](https://medium.com/what-i-learned-building/b4daab987fb0) among other
places. But I ran into a few issues on Windows.

First of all, since this functionality is not yet included in stable `sass` gems,
you need to get a `--pre` version of the gem. But it didn't work for me:

    $ gem install sass --pre --no-ri --no-rdoc
    ERROR:  While executing gem ... (Gem::DependencyError)
      Unable to resolve dependencies: sass requires listen (~> 1.1.0)

After some research I did find something that worked:

    $ gem install sass -v 3.3.0.rc.2

Dependencies are installed, no errors shown; seems like it worked ! To make sure:

    $ scss --version
    Sass 3.3.0.rc.2 (Maptastic Maple)

Awesome ! But then I ran into another problem:

    C:\Windows\system32\cmd.exe /c (scss --sourcemap --trace C:\code\scss\style.scss C:\code\css\style.css)
    C:/Ruby200-x64/lib/ruby/2.0.0/pathname.rb:500:in `relative_path_from': different
     prefix: "C:/" and "C:\\code/tc/mockup/css" (ArgumentError)
            from C:/Ruby200-x64/lib/ruby/gems/2.0.0/gems/sass-3.3.0.rc.2/lib/sass/source/map.rb:128:in `block in to_json'
            from C:/Ruby200-x64/lib/ruby/gems/2.0.0/gems/sass-3.3.0.rc.2/lib/sass/source/map.rb:123:in `each'
            from C:/Ruby200-x64/lib/ruby/gems/2.0.0/gems/sass-3.3.0.rc.2/lib/sass/source/map.rb:123:in `to_json'
            from C:/Ruby200-x64/lib/ruby/gems/2.0.0/gems/sass-3.3.0.rc.2/lib/sass/exec.rb:378:in `process_result'
            from C:/Ruby200-x64/lib/ruby/gems/2.0.0/gems/sass-3.3.0.rc.2/lib/sass/exec.rb:43:in `parse'
            from C:/Ruby200-x64/lib/ruby/gems/2.0.0/gems/sass-3.3.0.rc.2/lib/sass/exec.rb:22:in `parse!'
            from C:/Ruby200-x64/lib/ruby/gems/2.0.0/gems/sass-3.3.0.rc.2/bin/scss:9:in `<top (required)>'
            from C:/Ruby200-x64/bin/scss:23:in `load'
            from C:/Ruby200-x64/bin/scss:23:in `<main>'
    shell returned 1
    Hit any key to close this window...

This problem is described in a couple of places, the best description I could
find being [on this RubyInstaller
issue](https://github.com/oneclick/rubyinstaller/issues/179). The issue is that
Ruby's Pathname wants files as `C:/code/source.scss`; it cannot accept
`C:\code\source.scss` - note the direction of the slash. The `sass` team is aware of this issue, and apparently
[has been
fixed](https://github.com/nex3/sass/commit/de40a35201b982524b2d04e52541b43e61a43097)
just a couple of days ago. The fix isn't in 3.3.0.rc.2, however, and by looking
at the affected files, monkey-patching could have unintended consequences.

So, if you're using `scss` from the command line, just give paths in the format which
Pathname can digest: `scss --sourcemaps C:/code/scss/style.scss C:/code/css/style.css`.

#### Vim Setup
Here I'll describe what I did to run `scss` automatically, so that everytime
`scss` file is saved, it is converted to CSS. To make this possible, we'll save
the OS path separator in a variable, and make a little function with will
convert paths to the `Pathname` format:

    " determine path separator
    if has('win16') || has('win32') || has ('win95') || has('win64')
        let s:sep = '\'
    else 
        let s:sep = '/'
    endif

    " converts a Windows path to Pathname format
    function! PathToPathname(path)
        if has('win16') || has('win32') || has ('win95') || has('win64')
            return substitute( a:path, '\\','/','g')
        else
            return a:path
        endif
    endfunction

We'll use this stuff in an `BufWritePost` autocommand:

    au BufWritePost *.scss :execute('!scss --sourcemap '.PathToPathname(expand('%:p')).' '.PathToPathname(expand('%:p:r').'.css'))

It's ugly, but it works.

_to be continued..._

*[HTML]: Hyper Text Markup Language
*[CSS]: Cascading Style Sheets
*[SCSS]: Syntactically Awesome Stylesheets
*[SASS]: Syntactically Awesome Stylesheets
